name: Deploy to Alibaba

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-alibaba-main
  cancel-in-progress: false

jobs:
  deploy-alibaba:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy over SSH (Alibaba)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALI_DEPLOY_HOST }}       # 47.245.133.217
          username: ${{ secrets.ALI_DEPLOY_USER }}    # admin
          key: ${{ secrets.ALI_DEPLOY_SSH_KEY }}      # приватный ключ для входа на сервер
          # Если ключ без пароля — УДАЛИ следующую строку:
          passphrase: ${{ secrets.ALI_DEPLOY_SSH_PASSPHRASE }}
          port: 22
          script: |
            set -euo pipefail

            # Preflight: DNS/TLS на удалённой машине
            getent hosts github.com >/dev/null
            curl -sSfI https://github.com -m 10 >/dev/null

            # Всё выполняем от имени myapp через heredoc — без кавычечных ловушек
            sudo -u myapp bash -s <<REMOTE
            set -euo pipefail
            cd /srv/myapp/repo

            # Репозиторий по SSH (deploy key у myapp)
            git remote set-url origin git@github.com:Mrdoker1/Taro.git || true
            git fetch origin main --quiet
            git checkout main || git checkout -b main
            git pull --ff-only

            # Установка зависимостей и сборка
            if [ -f package-lock.json ]; then
              npm ci
            else
              npm install --no-audit --no-fund
            fi
            npm run build

            # Метка деплоя (ВАЖНО: без одинарных кавычек в формате даты)
            echo "sha=${GITHUB_SHA} time=\$(date -u +%Y-%m-%dT%H:%M:%SZ)" > .deploy_info

            # PM2: рестарт, иначе старт
            if pm2 describe myapp-api >/dev/null 2>&1; then
              pm2 restart myapp-api --update-env
            else
              pm2 start "npm -- start" --name myapp-api --time
            fi

            pm2 save
            echo "ALIBABA DEPLOYED \$(cat .deploy_info)"
REMOTE
