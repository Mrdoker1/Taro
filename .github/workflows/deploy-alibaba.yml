name: Deploy to Alibaba (artifact)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-alibaba-artifact
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install & Build on runner
        run: |
          set -euxo pipefail
          npm ci --no-audit --no-fund
          npm run build

          # Готовим runtime-артефакт с node_modules (чтобы не устанавливать на сервере)
          rm -rf deploy_artifact
          mkdir -p deploy_artifact
          
          # Устанавливаем только production зависимости
          rm -rf node_modules
          npm ci --omit=dev --no-audit --no-fund
          
          cp -r dist node_modules package.json package-lock.json deploy_artifact/
          # .env НЕ кладём — он хранится на сервере

      - name: Copy artifact to server (as files)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ALI_DEPLOY_HOST }}
          username: ${{ secrets.ALI_DEPLOY_USER }}
          key: ${{ secrets.ALI_DEPLOY_SSH_KEY }}
          passphrase: ${{ secrets.ALI_DEPLOY_SSH_PASSPHRASE }}
          port: 22
          source: "deploy_artifact/*"
          target: "/tmp/deploy_artifact"
          rm: true

      - name: Release artifact on server (simple & safe)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.ALI_DEPLOY_HOST }}
          username: ${{ secrets.ALI_DEPLOY_USER }}
          key: ${{ secrets.ALI_DEPLOY_SSH_KEY }}
          passphrase: ${{ secrets.ALI_DEPLOY_SSH_PASSPHRASE }}
          port: 22
          command_timeout: 30m
          script: |
            set -euxo pipefail
            SHA="${GITHUB_SHA:-unknown}"

            # (Опционально) разовая подстраховка — если когда-то запускали PM2 под admin
            sudo -u admin pm2 kill || true

            # Все действия — от имени myapp
            sudo -u myapp SHA="$SHA" bash -s <<'REMOTE'
            set -euxo pipefail

            APP_NAME="myapp-api"
            PORT=3000
            SRC="/tmp/deploy_artifact"
            APP_DIR="/srv/myapp/repo"

            # Найти корень с package.json в артефакте
            if [ -f "$SRC/package.json" ]; then
              SRC_USE="$SRC"
            else
              SRC_USE="$(find "$SRC" -maxdepth 2 -type f -name package.json -printf '%h\n' -quit || true)"
              [ -n "$SRC_USE" ] || { echo "package.json не найден в $SRC"; exit 1; }
            fi
            echo "Using artifact at: $SRC_USE"

            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            # Небольшой бэкап на всякий
            mkdir -p ../releases
            TS="$(date -u +%Y%m%d%H%M%S)"
            if [ -d dist ] || [ -f package.json ]; then
              tar -czf "../releases/backup-$TS.tgz" dist package*.json .env* 2>/dev/null || true
            fi

            # Обновляем файлы, .env* не трогаем
            rsync -a --delete \
              --exclude '.env*' \
              "$SRC_USE"/ "$APP_DIR"/

            # Проверим, что .env на месте и не пуст
            [ -s .env ] || { echo ".env отсутствует или пуст — прерываю"; exit 1; }
            sed -i 's/\r$//' .env

            # node_modules уже в артефакте, ничего не устанавливаем
            echo "✅ Dependencies already included in artifact"

            # Метка деплоя
            echo "sha=$SHA time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > .deploy_info

            # Перезапуск без даунтайма (если есть), иначе старт
            export NODE_ENV=production
            if pm2 describe "$APP_NAME" >/dev/null 2>&1; then
              pm2 reload "$APP_NAME" --update-env
            else
              pm2 start /usr/bin/node --name "$APP_NAME" --time -- dist/src/main.js
            fi
            pm2 save

            # Короткий healthcheck (не усложняем откатами)
            if curl -fsS "http://127.0.0.1:$PORT/api" >/dev/null; then
              echo "API is healthy on :$PORT"
            else
              echo "WARNING: healthcheck failed (http://127.0.0.1:$PORT/api)" >&2
            fi

            echo "DEPLOYED $(cat .deploy_info)"
            REMOTE
